name: Monitor Latencia (Docker Version)

on:
  schedule:
    # Ejecutar cada 6 horas (puedes cambiarlo)
    - cron: "0 */6 * * *"
  workflow_dispatch: # Bot칩n para ejecutar manual desde la web

# Damos permiso al bot para escribir en el repositorio
permissions:
  contents: write

jobs:
  run-docker-bot:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar tu c칩digo del repositorio
      - name: Checkout del c칩digo
        uses: actions/checkout@v3

      # 2. Construir la imagen Docker (igual que hiciste en tu PC)
      - name: Construir Imagen Docker
        run: docker build -t latency-bot .

      # 3. Ejecutar el contenedor
      # El truco aqu칤 es "-v ${{ github.workspace }}:/app"
      # Esto conecta la carpeta del servidor de GitHub con la carpeta /app del contenedor
      # As칤, cuando el script guarde la imagen, aparecer치 fuera del contenedor.
      # ... (Pasos anteriores igual) ...

      - name: Ejecutar Monitor de Latencia
        run: |
          # Genera los archivos como root (dentro de Docker)
          docker run --rm -v ${{ github.workspace }}:/app latency-bot

          # ARREGLO M츼GICO:
          # Usamos sudo para cambiar el due침o de los archivos generados
          # de 'root' a '$USER' (el usuario actual de GitHub Actions)
          sudo chown $USER:$USER commit_strategy.sh latency_map.png

          # Si existe el log, tambi칠n lo recuperamos (el || true evita errores si no existe a칰n)
          sudo chown $USER:$USER connection_log.txt 2>/dev/null || true

      - name: Ejecutar Estrategia de Commits Din치mica
        run: |
          # Ahora que los archivos son nuestros, ya no dar치 error de permisos
          chmod +x commit_strategy.sh
          ./commit_strategy.sh

      # 4. Detectar cambios y hacer Commit
      - name: Guardar cambios (Commit & Push)
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # Verificamos si la imagen cambi칩
          git add latency_map.png

          # Hacemos commit solo si hay cambios, si no, no falla
          git commit -m "游늵 Update: Latency Map [Automated]" || echo "No changes to commit"

          git push
